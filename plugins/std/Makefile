include plugins/Makefile.inc

asm-y		+= arch/$(ARCH)/prologue.o
obj-y		+= std.o
obj-y		+= string.o

SYS-ASM		:= syscalls.S
asm-y		+= arch/$(ARCH)/$(SYS-ASM:.S=).o

SYS-DEF		:= syscall.def
SYS-ASM-COMMON	:= syscall-common.S

SYS-TYPES	:= syscall-types.h
SYS-CODES	:= syscall-codes.h
SYS-PROTO	:= syscall.h

cflags-y	+= -iquote $(obj)/arch/$(ARCH)/
cflags-y	+= -iquote $(obj)/include
cflags-y	+= -iquote $(obj)/arch/$(ARCH)/include

autogen-y	:=

ASMFLAGS	+= -D__ASSEMBLY__
ASMFLAGS	+= $(cflags-y)

$(obj)/arch/$(ARCH)/prologue.o: $(obj)/arch/$(ARCH)/$(SYS-ASM:.S=).o
$(obj)/$(obj-y): | $(obj)/arch/$(ARCH)/$(SYS-ASM:.S=).o

ifneq ($(MAKECMDGOALS),clean)
deps-after := $(obj)/arch/$(ARCH)/$(SYS-ASM:.S=).o
incdeps := y
endif

plugins/include/uapi/std/$(SYS-CODES): $(obj)/arch/$(ARCH)/$(SYS-DEF)
	$(E) "  GEN     " $@
	$(shell echo "/* Autogenerated */" > $@)
	$(shell echo "#ifndef __COMPEL_PLUGIN_STD_SYSCALL_CODES_H__" >> $@)
	$(shell echo "#define __COMPEL_PLUGIN_STD_SYSCALL_CODES_H__" >> $@)
	$(shell cat $^ | egrep -v '^#' | sed -e 's/\t\{1,\}/|/g' | awk -F '|' '{print "#define", $$(1), $$(2)}' >> $@)
	$(shell echo "#endif /* __COMPEL_PLUGIN_STD_SYSCALL_CODES_H__ */" >> $@)
autogen-y += plugins/include/uapi/std/$(SYS-CODES)


plugins/include/uapi/std/$(SYS-PROTO): $(obj)/arch/$(ARCH)/$(SYS-DEF)
	$(E) "  GEN     " $@
	$(shell echo "/* Autogenerated */" > $@)
	$(shell echo "#ifndef __COMPEL_PLUGIN_STD_SYSCALL_H__" >> $@)
	$(shell echo "#define __COMPEL_PLUGIN_STD_SYSCALL_H__" >> $@)
	$(shell echo "#include \"uapi/std/$(SYS-CODES)\"" >> $@)
	$(shell echo "#include \"uapi/std/$(SYS-TYPES)\"" >> $@)
	$(shell cat $^ | egrep -v '^#' | sed -e 's/\t\{1,\}/|/g' | awk -F '|' '{print "extern long ", $$(3), $$(4), ";"}' >> $@)
	$(shell echo "#endif /* __COMPEL_PLUGIN_STD_SYSCALL_H__ */" >> $@)
autogen-y += plugins/include/uapi/std/$(SYS-PROTO)

$(obj)/arch/$(ARCH)/$(SYS-ASM): $(obj)/arch/$(ARCH)/$(SYS-DEF) | $(autogen-y)
	$(E) "  GEN     " $@
	$(shell echo "/* Autogenerated */" > $@)
	$(shell echo "#include \"uapi/std/$(SYS-CODES)\"" >> $@)
	$(shell echo "#include \"$(SYS-ASM-COMMON)\"" >> $@)
	$(shell cat $^ | egrep -v '^#' | sed -e 's/\t\{1,\}/|/g' | awk -F '|' '{print "SYSCALL(", $$3, ",", $$2, ")"}' >> $@)

$(obj)/built-in.o: | $(autogen-y)

cleanup-y += $(obj)/arch/$(ARCH)/$(SYS-ASM)
cleanup-y += $(autogen-y)
